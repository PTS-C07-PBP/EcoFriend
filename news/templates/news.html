{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>News about Environmental Issues</title>
{% endblock meta %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/news_style.css' %}">
<div class="news" align="center">
    <div id="add-article">
        {% if user.is_authenticated %}
        <h1 class="mt-4 mb-5">Try writing about <br>enviromental issues in your country</h1>
        <form>
            <table>
                {% csrf_token %}
                {{ article_form.as_table }}
            </table>

            <input class="my-2 btn-add-article btn" type="submit" value="Add Article">
        </form>

        <a class="btn mt-3 mb-4" href="{% url 'news:reset' %}">Reset</a>
        {% endif %}
    </div>

    <div style="text-align: center;">
        <h1 class="mt-5 mb-4">News about Enviromental Issues</h1>
        <p>Powered by: </p>
        <div class="d-flex justify-content-center">
            <a href="https://news.un.org/en/news/topic/climate-change"><img width="100px" src="https://news.un.org/themes/custom/un_base_theme/images/logos/logo-en.svg"></a>
            <p id="un-news"><strong>News on Climate and Environment</strong></p>
        </div>
    </div>

    <div class="d-flex justify-content-center flex-wrap my-3">
        <form class="d-flex flex-row gap-3 align-items-center">
            {% csrf_token %}
            {{ filter_form.filter_region.label_tag }}
            {{ filter_form.filter_region }}
        </form>
    </div>

    <div id="articles" class="row d-flex justify-content-center flex-wrap">
    </div>

    <div class="d-flex justify-content-center mt-4 mb-5">
        <div id="pagination" class="btn-group" role="group" aria-label="pagination">
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
// Menggabungkan data article dengan sintaks HTML
function makeArticle(article) {
    if (article.fields.admin_created) {
        var html = "<div id='"+article.pk+"' class='col'><div class='card border border-success'><div class='card-body'><h5 class='card-title'><a href="+article.fields.link+">"+article.fields.title+"</a></h5>"
            html += "<p class='card-text'><small class='text-muted'>"+article.fields.date+"</small></p><p class='card-text'><small class='text-muted'>"+article.fields.region+"</small></p><p class='card-text'>"+article.fields.description+"</p><button class='btn' onclick='deleteArticle("+article.pk+");'>Delete</button></td></tr></div></div></div>"
    } else {
        var html = "<div id='"+article.pk+"' class='col'><div class='card border border-success'><img src="+article.fields.image+"class='card-img-top' width='200px'><div class='card-body'><h5 class='card-title'><a href="+article.fields.link+">"+article.fields.title+"</a></h5>"
        html += "<p class='card-text'><small class='text-muted'>"+article.fields.date+"</small></p><p class='card-text'><small class='text-muted'>"+article.fields.region+"</small></p><p class='card-text'>"+article.fields.description+"</p></div></div></div>"
    }
    return html;
}

// Menambah 10 article dan pagination
function add_articles(page_num) {
    $.get("/news/articles/", {'region':$('#id_filter_region').val(), 'page_num':page_num}, function(data) {
        $('#articles').html('');
        $.each(data[0], function(index, article) {
            $('#articles').append(makeArticle(article));
        });
        $('#pagination').html('');
        for (var page_num = 1; page_num <= data[1]; page_num++) {
            $('#pagination').append("<button type='button' class='btn' onclick='paginate("+page_num+");'>"+page_num+"</button>");
        }
    });
}
    
// Get article saat load
$(document).ready(function(){
    $.get("/news/init/", function(data) {
        $.each(data[0], function(index, article) {
            $('#articles').append(makeArticle(article));
        });
        $('#pagination').html('');
        for (var page_num = 1; page_num <= data[1]; page_num++) {
            $('#pagination').append("<button type='button' class='btn' onclick='paginate("+page_num+");'>"+page_num+"</button>");
        }
    });
});

// Filter article sesuai region
$('#id_filter_region').change(function() {
    add_articles(1);
});

// Fungsi saat menekan pagination
function paginate(page_num) {
    add_articles(page_num);
}

// Menambah article baru khusus admin
$(".btn-add-article").click(function(e) {
    e.preventDefault();
    $.post("/news/add/", {title: $('#id_title').val(), region: $('#id_region').val(), description: $('#id_description').val(), csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val()}, function(data) {
        add_articles(1);
    });
});

// Menghapus article yang dibuat admin
function deleteArticle(pk) {
    $.ajax({
        url: "/news/delete/"+pk,
        method: "DELETE",
        dataType: "json",
        beforeSend: function (xhr) {
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
        },
        success: function(data) {
            add_articles(1);
        }
    });
}
</script>
{% endblock content %}